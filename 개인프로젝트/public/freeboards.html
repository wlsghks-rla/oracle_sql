<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>자유게시판</title>
    <link rel="stylesheet" href="freeboards.css" />
  </head>
  <body>
    <div id="container">
      <header>
        <ul>
          <li id="welcome"></li>
          <li>
            <a href="index.html">로그아웃</a>
          </li>
        </ul>
        <h3>고양이를 위한 자유게시판</h3>
        <nav>
          <select name="categories" id="categories">
            <option value="total">전체</option>
            <option value="food">사료 후기</option>
            <option value="food">행동 성격</option>
            <option value="protect">입양 보호</option>
            <option value="ilsang">일상 공유</option>
            <option value="hoogi">용품 후기</option>
          </select>
          <button onclick="searchBoard()">검색</button>
        </nav>
      </header>
      <main>
        <table id="boardList">
          <thead>
            <tr>
              <th>번호</th>
              <th>제목</th>
              <th>작성자</th>
              <th>날짜</th>
              <th>분류</th>
            </tr>
          </thead>
          <tbody id="list"></tbody>
        </table>
        <section class="pagination"></section>
      </main>
      <button type="button" onclick="changing()" class="write">글쓰기</button>
    </div>
  </body>
  <script>
    // 사용자 정보 불러오기
    let uid = localStorage.getItem("uid");
    console.log(uid);
    let txt = document.createTextNode(`${uid}님 환영합니다`);

    document.querySelector("#welcome").appendChild(txt);

    searchBoard();

    async function searchCount() {
      let response = await fetch("/count");
      let result = await response.json();
      totalCount = result.length; // 전역변수에 저장
      console.log("총 게시글 수:", totalCount);
    }
    searchCount();

    let page = 1;
    function searchBoard() {
      let selectValue = document.querySelector("#categories");
      let values = selectValue.options[selectValue.selectedIndex].text;
      document.querySelector("#list").innerHTML = "";
      async function listing() {
        let response = await fetch(`/paging/${values}`);
        let result = await response.json(); // 자바스크립트 객체로 생성.
        // 페이지표시
        showPagingList(result.length);

        result = result.slice(0, 10);
        result.forEach((board) => {
          let [rn, title, author, dday, categories, idx] = board;
          let tr = document.createElement("tr");
          tr.dataset.id = idx;
          // 화면에 출력하기 위한 항목.
          let ddate = new Date(board[3]);
          ddate =
            ddate.getFullYear() +
            "-" +
            (ddate.getMonth() + 1) +
            "-" +
            ddate.getDate();
          board[3] = ddate;
          let realBoard = [board[0], board[1], board[2], board[3], board[4]];
          realBoard.forEach((prop) => {
            let td = document.createElement("td");
            td.innerHTML = prop;
            tr.appendChild(td);
          });

          let data = tr.dataset.id;
          tr.addEventListener("click", async (e) => {
            // datasets(data);
            let response = await fetch(`/boardpage/${data}`);
            let result = await response.json(); // 자바스크립트 객체로 생성.
            console.log(result);
            localStorage.setItem("boardPart", JSON.stringify(result));
            location.href = "boardpage.html";
          });

          document.querySelector("#list").appendChild(tr);
        });
      }
      listing();
    }

    async function datasets(data) {
      let response = await fetch(`/boardpage/${data}`);
      let result = await response.json(); // 자바스크립트 객체로 생성.
      console.log(result);
      localStorage.setItem("boardPart", JSON.stringify(result));
    }

    // pagination
    function showPagingList(totalCount) {
      let pagination = document.querySelector(".pagination");

      pagination.innerHTML = "";

      let startPage = 0,
        endPage = 0;
      let prev = false,
        next = false;
      endPage = Math.min(Math.ceil(page / 10) * 10);
      startPage = Math.max(endPage - 9, 1);
      let realEnd = Math.ceil(totalCount / 10);
      if (endPage > realEnd) {
        endPage = realEnd;
      }
      if (startPage != 1) {
        prev = true;
      }
      if (endPage < realEnd) {
        next = true;
      }
      let prevBtn = document.createElement("a");
      prevBtn.innerHTML = "&laquo";
      prevBtn.href = "#";
      prevBtn.setAttribute("data-page", startPage - 10);

      if (startPage > 1) {
        prevBtn.className = "prev";
      } else {
        prevBtn.className = "disabled";
      }
      pagination.appendChild(prevBtn);

      for (let p = startPage; p <= endPage; p++) {
        let tag = document.createElement("a");
        tag.innerText = p;
        tag.href = "#";
        tag.setAttribute("data-page", p);

        if (p == page) {
          tag.classList.add = "active";
        }
        pagination.appendChild(tag);
      }
      let nextBtn = document.createElement("a");
      nextBtn.innerHTML = "&raquo";
      nextBtn.href = "#";
      nextBtn.setAttribute("data-page", endPage + 1);

      if (endPage < realEnd) {
        nextBtn.className = "next";
      } else {
        nextBtn.className = "disabled";
      }
      pagination.appendChild(nextBtn);
    }

    // 페이징
    document
      .querySelector(".pagination") //
      .addEventListener("click", async (e) => {
        // totalcount
        async function searchCount() {
          let response = await fetch("/count");
          let result = await response.json();

          return result.length;
        }

        async function main() {
          let totalCount = await searchCount();
          console.log(totalCount); // 이제 숫자 출력
        }
        main();

        if (e.target.nodeName !== "A") return;
        if (e.target.classList.contains("disabled")) return;
        page = Number(e.target.dataset.page);

        let values =
          document.querySelector("#categories").options[
            document.querySelector("#categories").selectedIndex
          ].text;
        document.querySelector("#list").innerHTML = "";
        console.log(values);
        console.log(page);
        if (e.target.nodeName == "A") {
          // totalcount
          async function searchCount() {
            let response = await fetch("/count");
            let result = await response.json();

            return result.length;
          }

          async function main() {
            let totalCount = await searchCount();
            console.log(totalCount); // 이제 숫자 출력
          }
          async function boardList() {
            let response = await fetch(`/paging/${values}/${page}`);
            let result = await response.json(); // 자바스크립트 객체로 생성.
            // console.log(result);
            result.forEach((board) => {
              let [rn, title, author, dday, categories, idx] = board;
              // console.log(board[3]);
              let tr = document.createElement("tr");
              tr.dataset.id = board[5];
              // 화면에 출력하기 위한 항목.
              let ddate = new Date(board[3]);
              ddate =
                ddate.getFullYear() +
                "-" +
                (ddate.getMonth() + 1) +
                "-" +
                ddate.getDate();
              // console.log(ddate);
              board[3] = ddate;
              // console.log(board);
              let realBoard = [
                board[0],
                board[1],
                board[2],
                board[3],
                board[4],
              ];
              realBoard.forEach((prop) => {
                let td = document.createElement("td");
                // console.log(prop);
                td.innerHTML = prop;
                tr.appendChild(td);
              });
              let data = tr.dataset.id;
              tr.addEventListener("click", async (e) => {
                // datasets(data);
                let response = await fetch(`/boardpage/${data}`);
                let result = await response.json(); // 자바스크립트 객체로 생성.
                console.log(result);
                localStorage.setItem("boardPart", JSON.stringify(result));
                location.href = "boardpage.html";
              });

              document.querySelector("#list").appendChild(tr);
            });
            console.log(totalCount);
          }
          await boardList();
          showPagingList(totalCount);
        }
      });

    // 글작성 버튼 효과.
    function changing() {
      location.href = "writing.html";
    }
  </script>
</html>
